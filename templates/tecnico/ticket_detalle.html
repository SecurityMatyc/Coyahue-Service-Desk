{% extends "base_admin.html" %}
{% load static %}

{% block content %}

<div class="d-flex justify-content-between align-items-start mb-3">
    <div>
        <h1 class="h4 mb-1">Ticket #{{ ticket.id }} - {{ ticket.titulo }}</h1>
        <p class="text-muted mb-0">
            Detalle del ticket.
            {% if not asignacion_global %}
                <span class="text-warning">
                    Este ticket no está asignado a ningún técnico.
                </span>
            {% elif asignado_a_mi %}
                <span class="text-success">
                    Ticket asignado a ti.
                </span>
            {% else %}
                <span class="text-warning">
                    Ticket asignado a: {{ asignacion_global.tecnico_asignado.usuario.email }}
                </span>
            {% endif %}
        </p>
    </div>
</div>

<div class="row g-3">
    <div class="col-lg-8">
        <div class="card shadow-sm border-0 mb-3">
            <div class="card-body">
                <h6 class="text-uppercase text-muted small mb-3">Descripción</h6>
                <p class="mb-0">{{ ticket.descripcion|linebreaksbr }}</p>
            </div>
        </div>

        {% if puede_editar %}
            <!-- FORMULARIO SI EL TÉCNICO ES EL ASIGNADO -->
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <h6 class="text-uppercase text-muted small mb-3">Actualizar estado</h6>

                    <form method="post">
                        {% csrf_token %}

                        <div class="mb-3">
                            <label for="estado" class="form-label">Estado</label>
                            <select name="estado" id="estado" class="form-select">
                                {% for e in estados %}
                                    <option value="{{ e.id }}"
                                            {% if ticket.estado.id == e.id %}selected{% endif %}>
                                        {{ e.nombre_estado }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="comentario" class="form-label">Comentario</label>
                            <textarea
                                    name="comentario"
                                    id="comentario"
                                    rows="3"
                                    class="form-control"
                                    placeholder="Describe la acción realizada, diagnóstico, etc."></textarea>
                        </div>

                        <button type="submit" class="btn btn-primary">
                            Guardar cambios
                        </button>
                    </form>
                </div>
            </div>

            <!-- SECCIÓN DE COMENTARIOS -->
            <div class="card shadow-sm border-0 mt-3">
                <div class="card-body">
                    <h6 class="text-uppercase text-muted small mb-3">Comentarios</h6>

                    {% if comentarios %}
                        <div class="mb-3" style="max-height: 400px; overflow-y: auto;">
                            {% for comentario in comentarios %}
                                <div class="card mb-2 {% if comentario.usuario == ticket.solicitante %}border-primary{% else %}border-secondary{% endif %}">
                                    <div class="card-body p-2">
                                        <div class="d-flex justify-content-between align-items-start mb-1">
                                            <strong class="small">{{ comentario.usuario.get_full_name|default:comentario.usuario.email }}</strong>
                                            <span class="badge {% if comentario.usuario == ticket.solicitante %}bg-primary{% else %}bg-secondary{% endif %} badge-sm">
                                                {{ comentario.usuario.rol.nombre_rol }}
                                            </span>
                                        </div>
                                        <p class="small mb-1">{{ comentario.texto }}</p>
                                        {% if comentario.archivo %}
                                            <p class="small mb-1">
                                                <i class="bi bi-paperclip"></i>
                                                <a href="{{ comentario.archivo.url }}" target="_blank">Ver adjunto</a>
                                            </p>
                                        {% endif %}
                                        <small class="text-muted">{{ comentario.fecha_creacion|date:"d-m-Y H:i" }}</small>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="small text-muted">Aún no hay comentarios en este ticket.</p>
                    {% endif %}

                    <!-- Formulario para agregar comentario -->
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="mb-2">
                            <label for="comentario_texto" class="form-label small"><strong>Agregar comentario:</strong></label>
                            <textarea name="comentario_texto" id="comentario_texto" class="form-control form-control-sm" rows="3" placeholder="Escribe tu comentario aquí..."></textarea>
                        </div>
                        <div class="mb-2">
                            <label for="comentario_archivo" class="form-label small">Adjuntar archivo (opcional):</label>
                            <input type="file" name="comentario_archivo" id="comentario_archivo" class="form-control form-control-sm">
                        </div>
                        <button type="submit" class="btn btn-secondary btn-sm w-100">
                            <i class="bi bi-chat-left-text"></i> Enviar comentario
                        </button>
                    </form>
                </div>
            </div>
        {% else %}
            <!-- MENSAJE SOLO LECTURA CUANDO NO ESTÁ ASIGNADO A ESTE TÉCNICO -->
            <div class="alert alert-info small mt-2">
                {% if not asignacion_global %}
                    Este ticket no está asignado a ningún técnico. Puedes ver la
                    información, pero no modificar su estado.
                {% else %}
                    Este ticket está asignado a otro técnico
                    ({{ asignacion_global.tecnico_asignado.usuario.email }}).
                    Puedes ver la información, pero no modificar su estado.
                {% endif %}
            </div>
        {% endif %}
    </div>

    <div class="col-lg-4">
        <div class="card shadow-sm border-0">
            <div class="card-body">
                <h6 class="text-uppercase text-muted small mb-3">Información del ticket</h6>

                <dl class="row small mb-0">
                    <dt class="col-5">Estado</dt>
                    <dd class="col-7">{{ ticket.estado.nombre_estado }}</dd>

                    <dt class="col-5">Prioridad</dt>
                    <dd class="col-7">{{ ticket.prioridad.nombre_prioridad|default:"N/A" }}</dd>

                    <dt class="col-5">Área afectada</dt>
                    <dd class="col-7">{{ ticket.area_afectada.nombre_area|default:"-" }}</dd>

                    <dt class="col-5">Solicitante</dt>
                    <dd class="col-7">{{ ticket.solicitante.email }}</dd>

                    <dt class="col-5">Creado</dt>
                    <dd class="col-7">{{ ticket.fecha_creacion|date:"d-m-Y H:i" }}</dd>

                    {% if ticket.fecha_cierre %}
                    <dt class="col-5">Cerrado</dt>
                    <dd class="col-7 text-success">{{ ticket.fecha_cierre|date:"d-m-Y H:i" }}</dd>
                    {% endif %}
                </dl>
            </div>
        </div>
    </div>
</div>

{% endblock %}
